# AT Public Transport Emissions Analysis - Proof of Concept

## Table of Contents

- Abstract
- Background and Purpose
- Overview of Methodology
  - Data Sources
  - Bus Classification
  - Trip Data
  - Data Collation within Model
  - Data Filtering
  - Implementing the EI calculation methodology
- Assumptions and Interpolation
  - Dead Running
  - Other Assumptions
  - Excluded Analysis
  - Occupant Weight / Passenger Loading 
- Outputs and Visualisations of the Analysis Tool
- Recommendations for Future Analysis
- Conclusions

## Abstract

- To be completed

## Background and Purpose

- Outline the Stakeholders involved in this work (i.e. NZTA & AT)
- Outline the motivation and benefit for public bus emissions to be estimated using a software-driven approach
- Declare the intent to use the model already developed by generating the required inputs from provided data
- Outline the broad limitations of the approach (i.e. categories of assumptions)

**Draft**

There is currently a national drive to reduce emissions as a measure of mitigating human-induced climate change. Within the transport sector, public transport is an important method of reducing the emissions of the transport network as a whole. The majority of buses on New Zealand public transport networks are diesel. Therefore, improving national and regional understanding of the emissions of buses on the public transport network can assist with planning and decision-making at a high level to meet emission reduction goals.

The most accurate methodology to estimate emission quantities is to examine fuel consumption of the buses on a public transport network. However, this approach has several limitations. These include: 

- Buses on the network are typically used for other purposes (e.g. private charters, rail replacements, special services). The emissions generated by these activities are not attributable to public bus network.
- Fuel consumption data can be commercially sensitive under certain contractual frameworks.
- This data is not typically collected centrally by the public organisation operating the entire network.

As a result, a software-based approach using network operation data in conjunction with formulae from the European Union EMEP/EEA air pollutant emission inventory guidebook may be more suitable. This approach is likely to be easier to implement and roll out at a large scale while maintaining acceptable levels of accuracy. 

A successful trial was undertaken by GWRC and VUW in 2019 to use a software-based approach to calculate the present and historical emissions of the public transport bus fleet across the Wellington region. As a result of this trial, NZTA Waka Kotahi has requested a proof-of-concept study to examine whether this model can be applied to the Auckland region. This work was undertaken in collaboration with Victoria University of Wellington and supervised by Chris Vallyon.

This pilot study will examine the emissions generated by two bus operators on the Auckland network, Go Bus and Ritchies. Collectively, they service **TK Percentage**% of the trips across the Auckland bus network. Auckland Transport manages the public transport network across Auckland. They will provide the operational data that will be processed into the inputs for the emissions model. The emissions model then uses these inputs to generate an estimate of the emissions generated by each bus on a given trip. The output from the model can then be aggregated upwards to provide an estimate for the emissions generated by a given vehicle, a given route, or over the entire network.

This report will outline the methodology used to produce this model. In the instance where provided data may be incomplete or limited, any assumptions and interpolations required in order to generate a complete model will be described. 

## Definitions

**Trip** - A sequence of two or more stops scheduled to be completed at a specific time on a route.  
**Trip Instance** - The completion of a trip by a vehicle on a specific date.
**Route** - A route is a group of trips displayed to passengers under a single name/code.
**Service** - A service is a set of dates that a given trip operates on.

## Overview of Methodology

- Describe the retrieval of data from the developer's portal (i.e. the various APIs and the data that they provide)
- Describe how the data sources are joined to generate the inputs for the model
- Outline the process of the model produced in the previous study 

The methodology used to apply the model to the Auckland context can be separated into the following two broad steps:

1. Procurement, joining, and filtering of raw operational data into the form used by the Emissions model.
2. Using the previously developed Emissions model to estimate and visualise large scale emissions based on the processed operational data.

The aim of the first step is to collate and generate several data fields for each trip in the analysed dataset. For reference, a trip is a sequence of two or more stops undertaken by a specific vehicle on a specific time and date. Each field typically serves one of two primary purposes: to assist with filtering for further analysis/visualisation or as an input to the emissions model. A database schema with these fields and the required data types/formats for our model is included at the end of this report **TK To be completed!!!** .
The data inputs to the emissions model are as follows:

- EURO classification of the engine of the vehicle that carried out the trip.
- Average speed (in kmh) of the vehicle over the entire trip.
- The distance of the trip in km.
- Tare weight (in kg) of the vehicle that carried out the trip.
- Passenger loading represented by the total distance travelled by individual passengers on the trip in km.

The data fields that assist with filtering and visualisation are as follows:

- Date the trip occurred on.
- The departure time of the vehicle from the first stop on the route.
- The name of the route that the trip services.
- The vehicle ID number that identifies the vehicle that carried out the trip within the operator's fleet list.

The emissions model was developed during the Wellington trial and reused on the Auckland bus operational data. This model is based on formulae from the European Union EMEP/EEA air pollutant emission inventory guidebook and NZTA data on the NZ personal vehicle fleet **references?**. The model estimates the following quantities for each trip:

- Fuel consumed in kg **TK(or liters?)**.
- The carbon dioxide equivalent (CO2-equiv) generated in kg. This is the sum of CO2 and the CO2 equivalent of other greenhouse gases (methane & nitrous oxide) produced by the combustion of diesel.
- The quantities of each of the non-CO2 greenhouse gases (methane and nitrous oxide) produced in kg.
- The quantities of pollutant gases (carbon monoxide, nitrogen oxides, hydrocarbons, and airborne particulate matter) produced in kg. These gases have a detrimental environmental and health impact in the environment they are emitted in.
- The CO2-equivalent generated if each passenger had instead travelled in an average personal car as the sole occupant. This is intended as an estimate for the carbon cost of not running a given trip.

The outputs from the model are visualised in a tool called "BEVis" that was developed as an extension of the Wellington trial. These visualisations are displayed later in the report.

The rest of this section will describe the implementation of this methodology that we developed and utilised over the course of this study.

### Data Sources

Most of the data used for this study was retrieved from the AT developer's portal API. GTFS and real-time data was utilised to generate a complete dataset of scheduled and observed trips. The following schedule data was retrieved from several of the GTFS APIs:

API Endpoint | Data Field | Data Type | Description 
--- | --- | --- | ---
Trips | trip_id | String | Unique identifier for the scheduled trip. 
Trips | route_id | String | Unique identifier for the route the trip services.
Trips | service_id | String | Unique identifier for the service schedule the trip operates. 
Routes | route_id | String | As above - Used to join data from different API endpoints.
Routes | route_short_name | String | The short name of the route the trip serviced.
Routes | agency_id | String | The code for the bus operator that operates a given route.
Calendar | service_id | String | As above - Used to join data from different API endpoints.
Calendar | start_date | String | The date that a service schedule begins operating.
Calendar | end_date | String | The date that a service schedule stops operating.
Calendar | [Weekday-name] | boolean | A field for each day of the week with a boolean (1 or 0) indicating whether the service operates on that day.
CalendarDates | service_id | String | As above - Used to join data from different API endpoints.
CalendarDates | date | String | The date that an exception to the regular service schedule occurs.
CalendarDates | exception_type | integer | The type of exception that occurs. E.g. whether a service runs when it would not be regularly scheduled or vice versa.


<br>The following data was retrieved from the real-time trip updates API:

Data Field | Data Type | Description 
--- | --- | ---
trip_id | String | Unique identifier for the scheduled trip. 
date | String | The date that a given trip occurred.
arrived? | Boolean | Boolean indicating whether a trip is recorded as completed (arrived at the final stop in the sequence).
start_time | String | The time that the trip began.
stop_time_arrival | int | The most recent stop time for the bus on the trip. This value is provided as an epoch timestamp.
vehicle_id | String | The "Rapid Vehicle Number" uniquely identifies a vehicle within the entire Auckland bus fleet.

<br>In addition to the data publicly available via the Developer's Portal, two further sets of data were received directly from Auckland Transport. They are the Auckland Bus Operator fleet list and passenger km (pax_km) data. The fleet list contained the following data relevant to the study:

Data Field | Description 
--- | ---
vehicle_id | The "Rapid Vehicle Number" that uniquely identifies a vehicle within the entire Auckland bus fleet.
Operator_code | The code identifying the vehicle's operator.
Engine_rating | The EURO classification of the vehicle's engine.
tare_weight | The weight of the unloaded bus in kg.

<br>The pax_km data passenger km and vehicle distance data for the date range of 12/24/2020 through to 30/12/2020. The data provided was aggregated to contain values for a given vehicle on a given route over the entire date range. The relevant data fields are shown below:

Data Field | Description 
--- | ---
Rapid vehicle number | The number that uniquely identifies a vehicle within the entire Auckland bus fleet.
Display route number | A short numeric code that represents the route. This code corresponds to the "route_short_name" from the Routes GTFS API endpoint.
Vehicle trips | The number of trips completed by the vehicle on the route over the specified date range.
Vehicle kms | The total distance travelled by the vehicle on the route over the specified date range.
Pax kms | The total distance travelled by passengers on the vehicle on the route over the specified date range.

<br>

### Data Storage and Access

Storing a significant amount of data in a reliable and widely accessible manner necessitates the use of a hosted database. Two database technologies were considered for this study: MySQL & MongoDB.  
MySQL was considered as it is an implementation of SQL. SQL in conjunction with a relational database is the most popular database management system, particularly for large-scale enterprise contexts. It is very likely that transport agencies already use some form of SQL and a RDBMS to store and manage their public transport data.  
MongoDB is a newer database management system and the most popular NoSQL database available. It is widely used in several contexts although typically not in legacy systems or contexts where data integrity must be maintained (e.g. healthcare & finance).

Although MYSQL would more closely relate to the database systems currently in use by transport agencies, MongoDB was selected for use in this project. This was primarily due to the higher quality free option available and pre-existing skillsets allowing for greater progress to be made during the short timeframe of the project.

### Data Collation within the Model 

**Note** The following section outlines how the inputs to the emissions model were derived from the data sources (outlined above) within the context of a proof of concept. As there are multiple data sources with several different unique identifiers this process was relatively complex. The view of the authors is that the large scale implementation of this methodology would involve direct access to the underlying data which we suspect would require a significantly altered and less complex methodlogy. As a result of these two factors, the following methodology is included for reference only and may not be useful for developing any enterprise software intended for a large scale roll-out of the emissions model.

Collecting data from the Developer Portal APIs was carried out using an automated script to pull the real-time data at 30 second intervals. The script was hosted on the university servers to minimise the script's downtime. The real-time data was posted directly to the MongoDB in a collection containing all the collected raw data. 
The real-time trip instances were joined to the GTFS routes collection using the *route_id*. Then, they were filtered to the relevant operators using the *agency_id* in the GTFS routes data. The output of this process is a collection of observed trip instances that were carried out by Ritchies & Go Bus. These trip instances contained the following input data for the emissions model:

- Date
- Vehicle ID
- Route name
- Trip start time
- Trip duration - Derived from the start and end times present in each trip instance

The trip instances can be uniquely identified using a concatenation of the date the trip instance occurred and its trip_id (as shown below). This unique identifier was applied to each trip instance in the filtered real-time data.

<p align=center> Unique Trip Instance Identifier format - <b>[Date]_[Trip_id]</b></p>

**Move the schedule validation below to assumptions?**

A collection of scheduled trip instances was also generated to validate the completeness of the real-time data. The scheduled (GTFS) data was collected when a version change occurred. The general process to generate the scheduled trip instances is as follows:

- The trips are joined to the routes using the *route_id* and then filtered using the *agency_id* to identify the set of trips operated by Ritchies & Go Bus. 
- The trips are then joined to a set of dates they are scheduled to occur on using the *service_id*. The set of dates a particular service should occur on is generated by identifying the date range of the service; identifying the days of the week within the date range that the service should ocur on; and finally adding/removing the dates specified in *CalendarDates*.
- Each scheduled trip instance is assigned a unique identifier with the same format mentioned previously.

The unique identifiers were used to identify the proportion of scheduled trips observed in the real-time data. The proportion of scheduled trips not observed was found to be **TK Percentage**%. This proportion is low enough to assume that any scheduled trips that were not observed did not actually run. As a result, the only Developer's Portal data sources used in the final model were the Real-time Trip Updates and the GTFS routes.

**End schedule Validation**

- Join to vehicle - vehicle_id
- Join to distance and pax_km - route_short_name [ discuss issues around this elsewhere ]
- Then we have all the inputs to calculate emissions on a trip instance basis 

The vehicle data is joined to each trip instance using the *vehicle_id*. This provides each trip instance with the tare weight and the EURO rating of the vehicle that operated it. 

The final data to join in preparation for input into the emissions model is the distance and pax_km data. The provided data was aggregated to the route-vehicle level. I.e. the data contained the distance travelled by a particular vehicle on a particular route over the reviewed time period. As the emissions model operates on the basis of trip instances, this required some assumptions about how to apply the distance and pax_km values to individual trip instances. A summary of the process to assign this data to trip instances is as follows:

- Identify the *vehicle_id* and the *route_short_name* for each real-time trip instance.
- Use these two values to identify the corresponding entry in the distance/pax_km data.
- Calculate the average distance and pax_km per trip by dividing the total distance and pax_km by the *Vehicle trips* field. The average distance and pax_km are then assigned to the relevant trip instance.

The assumptions and resulting consequences inherent in this process are detailed further in the next section of the report.  
Each trip instance now has the required data for the emissions model to estimate the generated emissions for each trip instance. A diagram of the full procedure is included below.

**TK Insert diagram!**

## Assumptions and Interpolations

**Important section**

- Outline the assumptions made when forming the model inputs from the data
- Outline the assumptions inherent the model already (e.g. emissions calculated at the trip level based on average speed)
- Outline the assumptions around passenger loading and the impacts of it on the model
- Present results of comparison to real fuel consumption data (if we receive the data)

Summary of assumptions?


### Distance & Passenger Kilometer Data

### Emissions Model

## Outputs and Visualisations of the Analysis Tool

- Images of the preliminary results generated by BEVis
- Brief description of outputs of the model

## Recommendations for Future Analysis

- To be completed

## Conclusions

- To be completed